server {
    listen 8443 ssl;
    http2 on;                
    server_name YummyYard.local localhost; 

    # SSL/TLS
    ssl_certificate /etc/letsencrypt/localhost.crt;   
    ssl_certificate_key /etc/letsencrypt/localhost.key; 
    ssl_protocols TLSv1.2 TLSv1.3;                     
    ssl_prefer_server_ciphers on;                      
    ssl_ciphers 'HIGH:!aNULL:!MD5';                     

    # SSL Optimization
    ssl_session_cache shared:SSL:10m; 
    ssl_session_timeout 1h;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;   
    add_header X-XSS-Protection "1; mode=block" always; 
    add_header X-Content-Type-Options "nosniff" always; 
    add_header Referrer-Policy "strict-origin-when-cross-origin" always; 

    # Error pages
    error_page 404 /404.html; 
    error_page 500 502 503 504 /50x.html;        

    location = /404.html {
        root /var/www/html/errors;                             
        internal;                                       
    }

    location = /50x.html {
        root /var/www/html/errors;                             
        internal;                                      
    }

    # Timeouts (must be at server level)                       
    client_body_timeout 10s;                       
    client_header_timeout 10s;                   
    send_timeout 10s;                             
    keepalive_timeout 30s;                          

    # Buffers (must be at server level)
    large_client_header_buffers 4 8k;

    location / {
        proxy_pass http://web:8000;                   
        proxy_set_header Host $host;                 
        proxy_set_header X-Real-IP $remote_addr;        
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        proxy_set_header X-Forwarded-Proto $scheme;   
        proxy_intercept_errors on;

        # Timeouts
        proxy_connect_timeout 30s;                    
        proxy_send_timeout 30s;                        
        proxy_read_timeout 30s;

        # Buffers
        proxy_buffer_size   128k;                     
        proxy_buffers       4 256k;                  
        proxy_busy_buffers_size 256k;                 
        client_body_buffer_size 128k;                  
    }

    # Static files 
    location /static/ {
        alias /static_volume/;                         
        expires 1y;                                   
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;   
    }

    # Media files
    # location /media/ {
    #     alias /media_volume/;                          
    #     expires 6M;                                    
    #     add_header Cache-Control "public";              
    # }

    # Allow docker networks
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 172.0.0.0/8;  
        deny all;
    }

    # Logging
    access_log /var/log/nginx/yummyyard_access.log main;   
    error_log  /var/log/nginx/yummyyard_error.log warn;    
}

server {
    listen 8080;                                        
    server_name YummyYard.local localhost;             
    return 301 https://$host:8443$request_uri;          
}